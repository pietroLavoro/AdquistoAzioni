<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="container">
  <h2 class="mb-3">Nuovo Acquisto</h2>

  <p *ngIf="error" class="p-error" style="margin-bottom:1rem;">{{ error }}</p>

  <form [formGroup]="form" (ngSubmit)="doPreview()" class="p-fluid" novalidate>
    <!-- Titolo -->
    <div class="p-field" style="margin-bottom:1rem;">
      <label for="titolo" class="p-d-block">Titolo</label>
      <p-dropdown
        id="titolo"
        formControlName="titoloCodice"
        [options]="titoli"
        optionLabel="descrizione"
        optionValue="codice"
        placeholder="Seleziona titolo"
        [showClear]="true">
      </p-dropdown>
      <small class="p-error" *ngIf="form.get('titoloCodice')?.touched && form.get('titoloCodice')?.invalid">
        Seleziona un titolo.
      </small>
    </div>

    <!-- Data -->
    <div class="p-field" style="margin-bottom:1rem;">
      <label for="data" class="p-d-block">Data acquisto</label>
      <p-calendar
        id="data"
        formControlName="dataCompra"
        dateFormat="yy-mm-dd"
        [showIcon]="true"
        inputId="dataCompra">
      </p-calendar>
      <small class="p-error" *ngIf="form.get('dataCompra')?.touched && form.get('dataCompra')?.invalid">
        Data non valida (formato: yyyy-mm-dd).
      </small>
      <div class="mt-2">
        <button type="button" pButton label="Suggerisci data" (click)="onSuggerisciData()"></button>
      </div>
    </div>

    <!-- Quantità -->
    <div class="p-field" style="margin-bottom:1rem;">
      <label for="qta" class="p-d-block">Quantità totale</label>
      <p-inputNumber id="qta" formControlName="quantitaTotale" [minFractionDigits]="0"></p-inputNumber>
      <small class="p-error" *ngIf="form.get('quantitaTotale')?.touched && form.get('quantitaTotale')?.invalid">
        Inserisci una quantità &ge; 1.
      </small>
    </div>

    <!-- Importo -->
    <div class="p-field" style="margin-bottom:1rem;">
      <label for="imp" class="p-d-block">Importo totale</label>
      <p-inputNumber id="imp" formControlName="importoTotale" mode="currency" currency="EUR" [minFractionDigits]="2"></p-inputNumber>
      <small class="p-error" *ngIf="form.get('importoTotale')?.touched && form.get('importoTotale')?.invalid">
        Inserisci un importo &gt; 0.
      </small>
    </div>

    <!-- Acciones -->
    <div class="p-formgroup-inline" style="gap:.5rem; margin:1rem 0;">
      <button type="submit" pButton label="Previsualizar" [loading]="loading"></button>
      <button type="button" pButton label="Conferma" class="p-button-success" (click)="doConferma()" [disabled]="loading || form.invalid"></button>
      <button type="button" pButton label="Reset saldi" class="p-button-secondary" (click)="resetSaldos()" [disabled]="loading"></button>
    </div>
  </form>

  <!-- Preview -->
  <div *ngIf="preview" class="p-card" style="padding:1rem; margin-top:1rem;">
    <h3>Preview</h3>
    <pre style="white-space: pre-wrap; word-break: break-word;">{{ preview | json }}</pre>
    <div style="margin-top:.5rem; display:flex; gap:.5rem;">
      <button type="button" pButton label="Conferma" class="p-button-success" (click)="confirmarDesdePreview()" [disabled]="loading"></button>
      <button type="button" pButton label="Annulla" class="p-button-secondary" (click)="cancelarPreview()" [disabled]="loading"></button>
    </div>
  </div>

  <!-- Indicadores -->
  <div style="margin-top:1rem;">
    <span>Saldo totale disponibile: <b>{{ saldoTotaleDisponibile | number:'1.2-2' }} €</b></span>
    <span *ngIf="badgeType === 'warn'" class="p-tag p-tag-warning" style="margin-left:.5rem;">Importo &gt; saldo</span>
    <span *ngIf="badgeType === 'neg'" class="p-tag p-tag-danger" style="margin-left:.5rem;">Saldo negativo</span>
    <span *ngIf="badgeType === 'ok'" class="p-tag p-tag-success" style="margin-left:.5rem;">OK</span>
  </div>

  <!-- Tabla -->
  <div style="margin-top:1rem;">
    <p-table [value]="rows" [tableStyle]="{ 'min-width': '30rem' }">
      <ng-template pTemplate="header">
        <tr>
          <th>Agente</th>
          <th>Saldo disponibile</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-r>
        <tr>
          <td>{{ r?.nome ?? r?.cognome ?? '-' }}</td>
          <td>{{ r?.saldoDisponibile | number:'1.2-2' }}</td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="2">Nessun dato</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
