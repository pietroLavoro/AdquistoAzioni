<!-- Layout 2 columnas con tarjetas -->
<div class="app-grid">

  <!-- Columna izquierda: FORM -->
  <p-card class="card">
    <ng-template pTemplate="title">Nuevo acquisto</ng-template>

    <form [formGroup]="form" novalidate class="p-fluid form-grid">
      <!-- Código Título + saldo -->
      <div class="row-inline">
        <div class="field">
          <label for="titoloCodice">Código Título </label>
          <p-select
            id="titoloCodice"
            formControlName="titoloCodice"
            [options]="titoli"
            optionLabel="descrizione"
            optionValue="codice"
            placeholder="Seleccione título"
            [showClear]="true"
            style="min-width: 260px">
          </p-select>
        </div>

        <!-- Badge de saldo total disponible -->
        <p-tag
          *ngIf="saldoTotaleDisponibile != null"
          [value]="'Saldo total: ' + (saldoTotaleDisponibile | number:'1.2-2')"
          [severity]="badgeType === 'ok' ? 'success' : (badgeType === 'warn' ? 'warn' : 'danger')">
        </p-tag>
      </div>

      <!-- Fecha -->
      <div class="field">
        <label for="dataCompra">Fecha</label>
        <p-datepicker
          id="dataCompra"
          formControlName="dataCompra"
          dateFormat="yy-mm-dd"
          dataType="string"
          [showIcon]="true"
          inputId="dataCompra"
          style="min-width: 220px">
        </p-datepicker>
      </div>

      <!-- Importe total -->
      <div class="field">
        <label for="imp">Importe total</label>
        <p-inputNumber
          inputId="imp"
          formControlName="importoTotale"
          mode="currency"
          currency="EUR"
          [min]="0"
          [step]="1">
        </p-inputNumber>
      </div>

      <!-- Cantidad total -->
      <div class="field">
        <label for="qta">Cantidad total</label>
        <p-inputNumber
          inputId="qta"
          formControlName="quantitaTotale"
          [min]="1"
          [step]="1"
          [useGrouping]="false">
        </p-inputNumber>
      </div>

      <!-- Acciones -->
      <div class="actions">
        <p-button
          label="Previsualizar"
          icon="pi pi-eye"
          (onClick)="doPreview()"
          [disabled]="loading || form.invalid">
        </p-button>

        <p-button
          label="Sugerir fecha"
          icon="pi pi-calendar-plus"
          severity="secondary"
          (onClick)="onSuggerisciData()"
          [disabled]="loading || !form.get('titoloCodice')?.value || numAgentiAttivi === 0">
        </p-button>

        <p-button
          label="Reiniciar saldos"
          icon="pi pi-refresh"
          severity="warn"
          (onClick)="resetSaldos()"
          [disabled]="loading">
        </p-button>
      </div>

      <p *ngIf="error" class="err">Error: {{ error }}</p>
    </form>

    <!-- PREVISUALIZACIÓN -->
    <p-panel *ngIf="preview" header="Previsualización" class="mt-3">
      <div class="preview-info">
        <p>
          <strong>Título:</strong> {{ preview!.titoloCodice }}
          &nbsp; | &nbsp;
          <strong>Fecha:</strong> {{ preview!.dataCompra }}
          &nbsp; | &nbsp;
          <strong>Importe total:</strong> {{ preview!.importoTotale | number : '1.2-2' }}
          &nbsp; | &nbsp;
          <strong>Cantidad total:</strong> {{ preview!.quantitaTotale }}
        </p>
      </div>

      <p-table [value]="preview!.riparto" [responsiveLayout]="'scroll'" [tableStyle]="{ 'min-width': '30rem' }">
        <ng-template pTemplate="header">
          <tr>
            <th>Agente ID</th>
            <th>CF</th>
            <th class="text-right">Importe asignado</th>
            <th class="text-right">Cantidad asignada</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-r>
          <tr>
            <td>{{ r.agenteId }}</td>
            <td>{{ r.codiceFiscale }}</td>
            <td class="text-right">{{ r.importoAgente | number : '1.2-2' }}</td>
            <td class="text-right">{{ r.quantitaAgente }}</td>
          </tr>
        </ng-template>
      </p-table>

      <div class="actions mt-2">
        <p-button
          [label]="loading ? 'Confirmando…' : 'Confirmar compra'"
          icon="pi pi-check"
          (onClick)="confirmarDesdePreview()"
          [disabled]="loading">
        </p-button>

        <p-button
          label="Cancelar"
          icon="pi pi-times"
          severity="secondary"
          (onClick)="cancelarPreview()"
          [disabled]="loading">
        </p-button>
      </div>
    </p-panel>
    <!-- /PREVISUALIZACIÓN -->
  </p-card>

  <!-- Columna derecha: SALDOS -->
  <p-card class="card">
    <ng-template pTemplate="title">
      Saldos {{ isTodaySelected() ? 'en vivo' : 'a la fecha' }}
      <small *ngIf="isTodaySelected()" class="muted"> (actualiza cada 5s)</small>
    </ng-template>

    <p-table
      [value]="rows"
      [responsiveLayout]="'scroll'"
      [tableStyle]="{ 'min-width': '28rem' }">
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 5rem">ID</th>
          <th>CF</th>
          <th class="text-right">Saldo disp.</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-r>
        <tr>
          <td>{{ r.id }}</td>
          <td>{{ r.codiceFiscale }}</td>
          <td class="text-right" [ngClass]="{ 'neg': r.saldoDisponibile < 0 }">
            {{ r.saldoDisponibile | number : '1.2-2' }}
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr><td colspan="3" class="muted text-center">Sin datos</td></tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<!-- Compras registradas (incrustado) -->
<p-card class="card mt-3">
  <ng-template pTemplate="title">Compras registradas</ng-template>
  <app-acquisti-list [embedded]="true"></app-acquisti-list>
</p-card>

<!-- Toast y ConfirmDialog de PrimeNG -->
<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>
