<!-- GRID 2 columnas + fila inferior -->
<div class="page-grid">
  <!-- IZQUIERDA: KPIs + FORM -->
  <section class="col left card p-card">
    <h2 class="title">Nuevo acquisto</h2>

    <!-- KPIs -->
    <div class="kpi-row">
      <p-card class="kpi" [subheader]="'Saldo total'">
        <div class="kpi-value" [ngClass]="{ neg: saldoTotaleDisponibile < 0 }">
          {{ saldoTotaleDisponibile | number : '1.2-2' }} €
        </div>
      </p-card>
      <p-card class="kpi" [subheader]="'Importe total'">
        <div class="kpi-value">{{ form.value.importoTotale || 0 | number : '1.2-2' }} €</div>
      </p-card>
      <p-card class="kpi" [subheader]="'Diferencia'">
        <div
          class="kpi-value"
          [ngClass]="{
            pos: diffImporteSaldo() > 0,
            zero: diffImporteSaldo() === 0,
            neg: diffImporteSaldo() < 0
          }"
        >
          {{ diffImporteSaldo() | number : '1.2-2' }} €
        </div>
        <div class="muted">{{ diffLabel }}</div>
      </p-card>
    </div>

    <!-- FORM -->
    <form [formGroup]="form" novalidate class="p-fluid form-grid">
      <div class="row-inline">
        <div class="field">
          <label for="titoloCodice">Código Título</label>
          <p-select
            inputId="titoloCodice"
            formControlName="titoloCodice"
            [options]="titoli"
            optionLabel="descrizione"
            optionValue="codice"
            placeholder="Seleccione título"
            [showClear]="true"
            style="min-width: 260px"
          >
          </p-select>
        </div>
      </div>

      <div class="field">
        <label for="dataCompra">Fecha</label>
        <p-datepicker
          inputId="dataCompra"
          formControlName="dataCompra"
          dateFormat="yy-mm-dd"
          dataType="string"
          [showIcon]="true"
          style="min-width: 220px"
        >
        </p-datepicker>
      </div>

      <div class="field">
        <label for="imp">Importe total</label>
        <p-inputNumber
          inputId="imp"
          formControlName="importoTotale"
          mode="currency"
          currency="EUR"
          [min]="0"
          [step]="1"
          [minFractionDigits]="0"
          [maxFractionDigits]="0"
        >
        </p-inputNumber>
      </div>

      <div class="field">
        <label for="qta">Cantidad total</label>
        <p-inputNumber
          inputId="qta"
          formControlName="quantitaTotale"
          [min]="1"
          [step]="1"
          [useGrouping]="false"
        >
        </p-inputNumber>
      </div>

      <div class="actions">
        <p-button
          label="Previsualizar"
          icon="pi pi-eye"
          (onClick)="doPreview()"
          [disabled]="loading || form.invalid"
        ></p-button>
        <p-button
          label="Sugerir fecha"
          icon="pi pi-calendar-plus"
          severity="secondary"
          (onClick)="onSuggerisciData()"
          [disabled]="loading || !form.get('titoloCodice')?.value || numAgentiAttivi === 0"
        ></p-button>
        <p-button
          label="Reiniciar saldos"
          icon="pi pi-refresh"
          severity="warn"
          (onClick)="resetSaldos()"
          [disabled]="loading"
        ></p-button>
      </div>

      <p *ngIf="error" class="err">Error: {{ error }}</p>
    </form>
  </section>

  <!-- DERECHA: Tabla + Gráfico (alturas sincronizadas) -->
  <section class="col right">
    <p-card class="card table-card">
      <div class="card-header tight">
        <h2>Saldos en vivo</h2>
        <small *ngIf="isTodaySelected()" class="muted">&nbsp;(actualiza cada 5s)</small>
      </div>

      <p-table
        class="dense live-balance-table"
        [value]="dedupedRows"
        [scrollable]="true"
        [scrollHeight]="'320px'"
      >
        <ng-template pTemplate="header">
          <tr>
            <th style="text-align: left; width: 5rem">ID</th>
            <th style="text-align: left">CF</th>
            <th style="text-align: right; width: 7rem">Títulos</th>
            <th style="text-align: right; width: 9rem">Saldo disp.</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-r>
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.codiceFiscale }}</td>
            <td class="text-right">{{ r.quantitaTitoli ?? 0 }}</td>
            <td class="text-right">{{ r.saldoDisponibile | number : '1.2-2' }}</td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="4" class="text-center muted">Sin datos</td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>

    <p-card class="card chart-card">
      <div class="card-header">
        <h2>Actividad de compras (15 días)</h2>
      </div>
      <div class="chart-wrap">
        <p-chart #chart type="bar" [data]="chartData" [options]="chartOptions"> </p-chart>
      </div>
    </p-card>
  </section>

  <!-- ABAJO: Compras registradas -->
  <section class="bottom">
    <p-card class="card bottom-card">
      <app-acquisti-list [embedded]="false"></app-acquisti-list>
    </p-card>
  </section>
</div>

<!-- Overlay de carga -->
<div class="loading-overlay" *ngIf="loading"><p-progressSpinner></p-progressSpinner></div>

<!-- Botón flotante de tema -->
<div class="theme-toggle">
  <p-button
    [icon]="isDark ? 'pi pi-sun' : 'pi pi-moon'"
    [label]="isDark ? 'Claro' : 'Oscuro'"
    severity="secondary"
    size="small"
    (onClick)="toggleDark()"
    aria-label="Cambiar tema"
  >
  </p-button>
</div>

<!-- PREVIEW -->
<p-dialog
  [(visible)]="previewVisible"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [dismissableMask]="true"
  [breakpoints]="{ '960px': '80vw', '640px': '95vw' }"
  [style]="{ width: '900px', maxWidth: '90vw' }"
  header="Previsualización"
>
  <ng-container *ngIf="preview as p">
    <div class="form-grid">
      <div class="row-inline muted">
        <strong>Título:</strong>&nbsp;<span>{{ p.titoloCodice }}</span>
        &nbsp;&nbsp;|&nbsp;&nbsp;<strong>Fecha:</strong>&nbsp;<span>{{ p.dataCompra }}</span>
        &nbsp;&nbsp;|&nbsp;&nbsp;<strong>Importe total:</strong>&nbsp;<span>{{
          p.importoTotale | number : '1.2-2'
        }}</span>
        &nbsp;&nbsp;|&nbsp;&nbsp;<strong>Cantidad total:</strong>&nbsp;<span>{{
          p.quantitaTotale
        }}</span>
      </div>

      <p-table
        [value]="p.riparto"
        [scrollable]="true"
        scrollHeight="300px"
        [style]="{ 'border-radius': '12px', overflow: 'hidden' }"
      >
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 7rem">Agente ID</th>
            <th>CF</th>
            <th class="text-right">Importe asignado</th>
            <th class="text-right">Cantidad asignada</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-r>
          <tr>
            <td>{{ r.agenteId }}</td>
            <td>{{ r.codiceFiscale }}</td>
            <td class="text-right">{{ r.importoAgente | number : '1.2-2' }}</td>
            <td class="text-right">{{ r.quantitaAgente }}</td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage"
          ><tr>
            <td colspan="4" class="text-center muted">Sin datos</td>
          </tr></ng-template
        >
      </p-table>
    </div>
  </ng-container>

  <ng-template pTemplate="footer">
    <div class="actions">
      <p-button
        [label]="loading ? 'Confirmando…' : 'Confirmar compra'"
        [disabled]="loading || !preview"
        (onClick)="confirmarDesdePreview()"
      ></p-button>
      <p-button
        label="Cancelar"
        severity="secondary"
        [disabled]="loading"
        (onClick)="cancelarPreview()"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>

<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>
